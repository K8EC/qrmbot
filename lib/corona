#!/usr/bin/perl

# coronavirus info for qrmbot
# written by aa4jq

use strict;
use utf8;
use feature 'unicode_strings';
binmode(STDOUT, ":utf8");

use File::Basename;
use Cwd 'realpath';
use lib dirname(realpath(__FILE__));
use Util;
use Colors;

# disable "experimental" warning on smart match operator use
no if $] >= 5.018, warnings => "experimental::smartmatch";

if ($ARGV[0] =~ /about/i){
  print "Current global coronavirus cases as reported by WHO and others. ";
  print "Source: https://www.worldometers.info/coronavirus/coronavirus-cases\n";
  exit 0;
}

# eggdrop doesn't split args on spaces
@ARGV=split(' ', join(' ',@ARGV));

my @interest;
my @states;

my @statesandterritories = ("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE",
  "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA",
  "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND",
  "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA",
  "WV", "WI", "WY", "DC", "GU", "AS", "MP", "PR", "VI", "UM", "FM", "MH", "PW",
  "AA", "AE", "AP");

my $i = 0;
while ($i <= $#ARGV) {
  if ($ARGV[$i] =~ /^[A-Z][A-Z]$/i and uc $ARGV[$i] ~~ @statesandterritories) {
    push @states, uc $ARGV[$i];
  } else {
    push @interest, lc $ARGV[$i];
  }
  $i++;
}

# not updating reliably
#my $url = "https://raw.githubusercontent.com/alext234/coronavirus-stats/master/data/who-global-cases.csv";
my $url = "https://www.worldometers.info/coronavirus/";
my $params = 
	"-eval 'set connection.receive_timeout = 10' " .
	"-eval 'set connection.retries = 1' " .
	"--dump";

if ($#interest >= 0) {
  my $found = 0;
  open(HTTP, '-|', "curl -s -k '$url' | sed -e 's|</tr>|</tr>\\n|g;'");
  binmode(HTTP, ":utf8");
  while (<HTTP>) {
#   print if m|</tr>| and m/USA/;
    if (m|<tr.*?>\s*([A-Za-z.]+ ?[ A-Za-z.]*)\s*<.*?align:right;?">\s*([0-9,]*)\s*</td>.*?>\s*(\+[0-9,]+)?\s*</td>.*?align:right;?">\s*([0-9,]*)\s*</td>.*?>\s*(\+[0-9,]+)?\s*</td.*?text-align:right;?">\s*([0-9,]*)\s*</td>.*?font-weight:bold;">\s*([0-9,]+)\s*</td>.*?text-align:right;?">\s*([0-9,]*)\s*</td|) {
#     print "1:$1 2:$2 3:$3 4:$4 5:$5 6:$6 7:$7 8:$8 9:$9 10:$10\n" if $1 eq "USA";
      my ($cty, $cty_total, $cty_newcases, $cty_deaths, $cty_newdeaths, $cty_recovered, $cty_active, $cty_serious) = ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10);
      $cty =~ s/ //g;
      $cty_deaths = 0 if not defined $cty_deaths or $cty_deaths eq "";
      $cty_recovered = 0 if not defined $cty_recovered or $cty_recovered eq "";
      $cty_serious = 0 if not defined $cty_serious or $cty_serious eq "";
      if ( lc $cty ~~ @interest ) {
	print bold($cty), ": $cty_total confirmed cases and $cty_deaths deaths";
	print "; ", yellow("$cty_newcases"), " new cases" if $cty_newcases ne "";
	print "; ", red("$cty_newdeaths"), " new deaths" if $cty_newdeaths ne "";
	print "; $cty_recovered total recovered." if $cty_recovered > 0;
	print("\n");
	$found = 1;
      }
    }
  }
  close(HTTP);
  print "not found\n" if $found == 0;
  exit 0 if ($#states == -1);
}

if ($#states >= 0) {
  my $url = "https://covidtracking.com/api/states";
  my $found = 0;
  open(HTTP, '-|', "curl -s -k '$url' | sed -e 's/},{/},\\n{/g'");
  binmode(HTTP, ":utf8");
  while (<HTTP>) {
    if (/"state":"([A-Z]{2})","positive":(\d+),"negative":(\d+|null),"pending":(\d+|null),"death":(\d+|null),/) {
      if ( uc $1 ~~ @states ) {
	print "State ", bold($1)," Covid19 tests: positive: ", yellow($2), ", negative: ", green($3);
	print ", pending: $4" if $4 ne "null" and $4 > 0;
	print ", deaths: ", red($5), "\n";
	$found = 1;
      }
    }
  }
  close(HTTP);
  print "not found\n" if $found == 0;
  exit 0;
}

my $date;
my ($incases, $indeaths, $inrecov) = (0, 0, 0);
my ($c, $d, $r) = (0,0,0);
open(HTTP, '-|', "elinks $params '$url'");
binmode(HTTP, ":utf8");
while (<HTTP>) {
  s/^\s*//;
  s/\[\d+\]//g;

  $date = "$1z" if /Last updated: (.*) GMT/;

  $incases = 1 if /Coronavirus Cases:/;
  $c = $1 if /^\s*([0-9,]+)\s*$/ and $incases == 1;
  $c =~ s/,//g if $incases == 1;
  $incases = 0 if $c != 0;

  $indeaths = 1 if /Deaths:/;
  $d = $1 if /^\s*([0-9,]+)\s*$/ and $indeaths == 1;
  $d =~ s/,//g if $indeaths == 1;
  $indeaths = 0 if $d != 0;

  $inrecov = 1 if /Recovered:/;
  $r = $1 if /^\s*([0-9,]+)\s*$/ and $inrecov == 1;
  $r =~ s/,//g if $inrecov == 1;
  $inrecov = 0 if $r != 0;
}
close(HTTP);

my $pct = sprintf("%0.1f", ($d/($d+$r)*100.0));
print "As of $date, there are ", yellow(commify($c)), " confirmed cases and ",
  red(commify($d)), " deaths, with ", lightblue(commify($r)),
  " recovered. Death rate ", red("$pct%"), " of resolved cases.\n";
exit 0;
